---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';

type BlogPost = CollectionEntry<'blog'>;

export async function getStaticPaths(): Promise<
  {
    params: { slug: string };
    props: { post: BlogPost; allPosts: BlogPost[] };
  }[]
> {
  const posts: BlogPost[] = await getCollection('blog');

  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post, allPosts: posts },
  }));
}

const { post, allPosts } = Astro.props as {
  post: BlogPost;
  allPosts: BlogPost[];
};

// use filesystem order directly
const currentIndex: number = allPosts.findIndex((p) => p.id === post.id);
const prevPost: BlogPost | undefined = allPosts[currentIndex - 1];
const nextPost: BlogPost | undefined = allPosts[currentIndex + 1];

const { Content } = await render(post);
const heading: string = post.data.title;
const pageTitle: string = `${heading} | Blog | Marco Mazzai`;

// parse date from DD-MM-YYYY
const dateParts: number[] = post.data.date.split('-').map(Number);
const [day, month, year] = dateParts;
const postDate: Date = new Date(year, month - 1, day);

const formattedDate: string = new Intl.DateTimeFormat('en-GB', {
  day: '2-digit',
  month: 'short',
  year: 'numeric',
}).format(postDate);
---

<BaseLayout title={pageTitle}>
  <h1>{heading}</h1>
  <p class='post-date'>{formattedDate}</p>
  <article>
    <Content />
  </article>
  <nav>
    {
      prevPost && (
        <a href={`/blog/${prevPost.data.slug}`}>← {prevPost.data.title}</a>
      )
    }
    {
      nextPost && (
        <a href={`/blog/${nextPost.data.slug}`}>{nextPost.data.title} →</a>
      )
    }
  </nav>
</BaseLayout>
