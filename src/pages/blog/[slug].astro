---
import { PAGE_TITLES } from '../../content.config';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';

type BlogPost = CollectionEntry<'blog'>;

export const getStaticPaths: () => Promise<
  {
    params: { slug: string };
    props: { post: BlogPost; allPosts: BlogPost[] };
  }[]
> = async () => {
  const posts: BlogPost[] = await getCollection('blog');

  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post, allPosts: posts },
  }));
};

const { post, allPosts } = Astro.props as {
  post: BlogPost;
  allPosts: BlogPost[];
};

const currentIndex: number = allPosts.findIndex((p) => p.id === post.id);
const prevPost: BlogPost | undefined = allPosts[currentIndex - 1];
const nextPost: BlogPost | undefined = allPosts[currentIndex + 1];

const { Content } = await render(post);

const blogSuffix = PAGE_TITLES.blogSuffix;
const heading: string = post.data.title;
const pageTitle: string = `${heading} ${blogSuffix}`;

// parse date from DD-MM-YYYY
const [day, month, year]: number[] = post.data.date.split('-').map(Number);
const postDate: Date = new Date(year, month - 1, day);
const formattedDate: string = new Intl.DateTimeFormat('en-GB', {
  day: '2-digit',
  month: 'short',
  year: 'numeric',
}).format(postDate);

const { slug: prevSlug, title: prevTitle }: { slug?: string; title?: string } =
  prevPost?.data ?? {};
const { slug: nextSlug, title: nextTitle }: { slug?: string; title?: string } =
  nextPost?.data ?? {};
---

<BaseLayout title={pageTitle}>
  <h1>{heading}</h1>
  <p class='post-date'>{formattedDate}</p>
  <article>
    <Content />
  </article>
  <nav>
    {prevSlug && <a href={`/blog/${prevSlug}`}>← {prevTitle}</a>}
    {nextSlug && <a href={`/blog/${nextSlug}`}>{nextTitle} →</a>}
  </nav>
</BaseLayout>
