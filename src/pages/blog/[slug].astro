---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';

type BlogPost = CollectionEntry<'blog'>;

export const getStaticPaths: () => Promise<
  {
    params: { slug: string };
    props: { post: BlogPost; allPosts: BlogPost[] };
  }[]
> = async () => {
  const posts: BlogPost[] = await getCollection('blog');

  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post, allPosts: posts },
  }));
};

const { post, allPosts } = Astro.props as {
  post: BlogPost;
  allPosts: BlogPost[];
};

const currentIndex: number = allPosts.findIndex((p) => p.id === post.id);
const prevPost: BlogPost | undefined = allPosts[currentIndex - 1];
const nextPost: BlogPost | undefined = allPosts[currentIndex + 1];

const { Content } = await render(post);

const SLUG_TITLE: string = '| Blog | Marco Mazzai';
const heading: string = post.data.title;
const pageTitle: string = `${heading} ${SLUG_TITLE}`;

// parse date from DD-MM-YYYY
const [day, month, year]: number[] = post.data.date.split('-').map(Number);
const postDate: Date = new Date(year, month - 1, day);
const formattedDate: string = new Intl.DateTimeFormat('en-GB', {
  day: '2-digit',
  month: 'short',
  year: 'numeric',
}).format(postDate);
---

<BaseLayout title={pageTitle}>
  <h1>{heading}</h1>
  <p class='post-date'>{formattedDate}</p>
  <article>
    <Content />
  </article>
  <nav>
    {
      prevPost && (
        <a href={`/blog/${prevPost.data.slug}`}>← {prevPost.data.title}</a>
      )
    }
    {
      nextPost && (
        <a href={`/blog/${nextPost.data.slug}`}>{nextPost.data.title} →</a>
      )
    }
  </nav>
</BaseLayout>
