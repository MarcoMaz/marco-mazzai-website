---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { PAGE_TITLES } from '../content.config';
import ProjectIframe from '../components/ProjectIframe.astro';

type PartialDate = Date | 'Present' | string;

type AboutEntry = CollectionEntry<'about'>;

type ProjectItem = {
  headline: string;
  type: string;
  description: string;
  date: { from: PartialDate; to?: PartialDate };
  tags: string[];
  githubUrl: string; 
  preview?: { title?: string; url: string; };
};

type WorkExperienceItem = {
  headline: string;
  description: string;
  role: string;
  date: { from: PartialDate; to?: PartialDate };
  location: string;
  tasks: string[];
};

const aboutCollection: AboutEntry[] = await getCollection('about');
if (aboutCollection.length === 0) {
  throw new Error('About page not found in copy collection');
}
const about: AboutEntry = aboutCollection[0];
const {
  headline,
  githubLabel,
  nda: { headline: ndaHeadline, images },
} = about.data;

type PetProjectsEntry = CollectionEntry<'petProjects'>;

const petProjectsCollection: PetProjectsEntry[] = await getCollection('petProjects');
if (petProjectsCollection.length === 0) {
  throw new Error('Pet Projects not found in copy collection');
}
const petProjectsDoc: PetProjectsEntry = petProjectsCollection[0];
const petProjects = petProjectsDoc.data.petProjectsItems as ProjectItem[];

type TagsCodingLanguagesEntry = CollectionEntry<'tagsCodingLanguages'>;

const tagsCodingDocs: TagsCodingLanguagesEntry[] = await getCollection('tagsCodingLanguages');
if (tagsCodingDocs.length === 0) {
  throw new Error('Tags & coding languages not found in copy collection');
}
const tagsCodingLanguages = tagsCodingDocs[0].data.tagsCodingLanguages as string[];


type WorkExperiencesEntry = CollectionEntry<'workExperiences'>;

const workExperiencesCollection: WorkExperiencesEntry[] = await getCollection('workExperiences');
if (workExperiencesCollection.length === 0) {
  throw new Error('Pet Projects not found in copy collection');
}
const workExperiencesDoc: WorkExperiencesEntry = workExperiencesCollection[0];
const workExperiences = workExperiencesDoc.data.workExperiencesItems as WorkExperienceItem[];

type EducationItem = {
  category: 'Frontend' | 'Accessibility';
  sections: Array<{
    type: 'Certifications' | 'Advanced Courses' | 'Conferences and Webinars';
    date?: { from?: PartialDate; to?: PartialDate };
    items: string[];
  }>;
};

type EducationEntry = CollectionEntry<'education'>;

const educationCollection: EducationEntry[] = await getCollection('education');
if (educationCollection.length === 0) {
  throw new Error('Education not found in copy collection');
}
const educationDoc: EducationEntry = educationCollection[0];
const educationItems = educationDoc.data.educationItems as EducationItem[];


type SocialLinksEntry = CollectionEntry<'socialLinks'>;

const socialLinksCollection: SocialLinksEntry[] = await getCollection('socialLinks');
if (socialLinksCollection.length === 0) {
  throw new Error('Social links not found in copy collection');
}
const socialLinks: SocialLinksEntry = socialLinksCollection[0];
const {
  headline: socialLinksHeadline,
  CTA: socialLinksCTA,
} = socialLinks.data;

const pageTitle = PAGE_TITLES.about;

const monthName = (m: number) =>
  new Date(2000, m - 1, 1).toLocaleString('en-GB', { month: 'long' });

const formatPartialDate = (v: PartialDate | undefined): string => {
  if (v === 'Present') return 'Present';
  if (!v) return '';

  if (v instanceof Date) {
    return v.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  }

  // v is string at this point (numbers were coerced)
  if (/^\d{4}$/.test(v)) return v; // "2024"

  const ym = v.match(/^(\d{4})-(\d{2})$/);
  if (ym) {
    const [, y, m] = ym;
    return `${monthName(Number(m))} ${y}`; // "July 2024"
  }

  const ymd = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (ymd) {
    const d = new Date(v);
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  }

  return String(v); // fallback
};

const formatDateRange = (from: PartialDate, to?: PartialDate): string => {
  const start = formatPartialDate(from);
  const end = formatPartialDate(to);

  // Normalize both values to plain strings for comparison
  const same = start === end || !end;

  if (same) return start; // show only one
  return `${start} – ${end}`;
};
---

<BaseLayout title={pageTitle}>
  <h2>{headline}</h2>
  <!-- Accordion (Desktop Navigation) -->
  <wa-accordion collapseOthers>
    {
      petProjects.map(({headline, type, description, date, tags, githubUrl, preview}: ProjectItem) => (
          <h3>{headline}</h3>
          <div>
            <em>{type}</em>
            <p>{description}</p>
            <span>{formatDateRange(date.from, date.to)}</span>
            <div>
              {tags.map((tag) => (
                <span>{tag}</span>
              ))}
            </div>
            {githubUrl && (
              <a href={githubUrl} target='_blank'>
                {githubLabel}
              </a>
            )}
            {
              preview && <ProjectIframe src={preview.url} title={preview.title}/>
            }
          </div>
      ))
    }
  </wa-accordion>
  <!-- Carousel (Mobile Navigation) -->
  <wa-carousel ariaLabel="Main Topic">
    {
      petProjects.map(({headline, type, description, date, tags, githubUrl, preview}: ProjectItem) => (
          <h3>{headline}</h3>
          <div>
            <em>{type}</em>
            <p>{description}</p>
            <span>{formatDateRange(date.from, date.to)}</span>
            <div>
              {tags.map((tag) => (
                <span>{tag}</span>
              ))}
            </div>
            {githubUrl && (
              <a href={githubUrl} target='_blank'>
                {githubLabel}
              </a>
            )}
            {
              preview && <ProjectIframe src={preview.url} title={preview.title}/>
            }
          </div>
          <p>{description}</p>
      ))
    }
  </wa-carousel>
  <ul>
  {tagsCodingLanguages.map((item) => <li>{item}</li>)}
</ul>

  <ul>

    {
      workExperiences.map(({ headline, description, role, date, location, tasks }) => (
        <li>
          <h3>{headline}</h3>
          <div>
            <em>{role}</em> — <span>{location}</span>
            <p>{description}</p>
            <span>{formatDateRange(date.from, date.to)}</span>
            <ul>
              {tasks.map((t) => <li>{t}</li>)}
            </ul>
          </div>
        </li>
      ))
    }
  </ul>
  <ul>

    {educationItems.map(({ category, sections }) => (
    <li>
      <h3>{category}</h3>

      {sections.map(({ type, date, items }) => (
        <article>
          <h4>
            {type}
            {date && (formatDateRange(date.from ?? '', date.to ?? '') && (
              <span> — {formatDateRange(date.from ?? '', date.to ?? '')}</span>
            ))}
          </h4>

          <ul>
            {items.map((label) => <li>{label}</li>)}
          </ul>
        </article>
      ))}
    </li>
  ))}
  </ul>


  <h2>{ndaHeadline}</h2>
  <div class='logos'>
    {
      images.map(({ src, alt }) => (
        <img src={src ?? undefined} alt={alt ?? ''} />
      ))
    }
  </div>
  <h2>{socialLinksHeadline}</h2>
  <ul>
    {socialLinksCTA.map(({ url, label }) => <li>{url && <a href={url}>{label}</a>}</li>)}
  </ul>
</BaseLayout>

<script>
  import 'wa11y-ui/wa-accordion';
  import 'wa11y-ui/wa-carousel';
</script>
